<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏û‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡∏ß</title>
</head>
<body>
  <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå</h2>
  <ul id="order-list"></ul>

  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
  <script>
    const socket = io('https://socket-order-server.onrender.com');

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà
    socket.on('new-order', (order) => {
      const li = document.createElement('li');
      li.id = `order-${order.id}`;

      const itemsHtml = order.items && order.items.length > 0 
        ? order.items.map(item => {
            const name = item.name || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π';
            const quantity = item.qty || 0;
            const image = item.image || '';
            return `üçΩÔ∏è ${name} (${quantity})<br>
                    <img src="${image}" alt="${name}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;">` ;
          }).join('<br>') 
        : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£';

      li.innerHTML = `
        <strong>‡πÇ‡∏ï‡πä‡∏∞ ${order.table}</strong><br>
        <strong>‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß: ${order.queueNumber}</strong><br>
        ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡πà‡∏á: ${order.orderTime}<br>
        ${itemsHtml}<br>
        <button onclick="updateStatus('${order.id}', 'accepted')">‚úÖ ‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
        <button onclick="updateStatus('${order.id}', 'done')">üç≥ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
        <button onclick="updateStatus('${order.id}', 'delivered')">üõµ ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</button>
        <p id="status-${order.id}">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡∏û‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡∏ß‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå</p>
      `;
      document.getElementById('order-list').appendChild(li);
    });

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å server
    socket.on('status-updated', ({ order }) => {
      console.log(order); // üîç ‡πÄ‡∏û‡∏¥‡πà‡∏° log ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤
      if (!order || !order.id) {
          console.error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå:', order);
          return; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö order ‡∏´‡∏£‡∏∑‡∏≠ order.id ‡∏Å‡πá‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠
      }

      const statusMap = {
          waiting: '‡∏£‡∏≠‡∏û‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡∏ß‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå',
          accepted: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£',
          done: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡∏™‡πà‡∏á',
          delivered: '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß'
      };

      const statusEl = document.getElementById(`status-${order.id}`);
      if (statusEl) {
          statusEl.innerText = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ' + statusMap[order.status];
      }

      // ‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô 'delivered' ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å DOM
      if (order.status === 'delivered') {
          const orderEl = document.getElementById(`order-${order.id}`);
          if (orderEl) {
              orderEl.remove(); // ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå
          }
      }
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á backend
    function updateStatus(id, status) {
      fetch(`https://socket-order-server.onrender.com/order/${id}/status`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status })
      })
      .then(res => res.json())
      .then(data => {
        console.log('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï:', data);
      })
      .catch(err => {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞');
        console.error(err);
      });
    }
  </script>
</body>
</html>
